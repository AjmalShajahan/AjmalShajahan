name: Spotify Metrics
# This workflow updates Spotify metrics on a schedule or when triggered manually/pushed to 'test'.
on:
  schedule:
    # Daily at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
  push: { branches: ["test"] }
jobs:
  spotify:
    runs-on: ubuntu-latest
    steps:
      # Parse Spotify credentials from the secret (comma-separated: client_id, client_secret, refresh_token)
      - name: Parse Spotify credentials
        id: parse_creds
        shell: bash
        run: |
          set -euo pipefail
          IFS=',' read -r client_id client_secret refresh_token <<< "$SPOTIFY_TOKENS"
          echo "client_id=$client_id" >> $GITHUB_OUTPUT
          echo "client_secret=$client_secret" >> $GITHUB_OUTPUT
          echo "refresh_token=$refresh_token" >> $GITHUB_OUTPUT
        env:
          SPOTIFY_TOKENS: ${{ secrets.SPOTIFY_TOKENS }}

      # Request a Spotify access token using the parsed credentials
      - name: Request Spotify access token
        id: get_token
        shell: bash
        run: |
          auth=$(printf "%s:%s" "${{ steps.parse_creds.outputs.client_id }}" "${{ steps.parse_creds.outputs.client_secret }}" | base64 | tr -d '\n')
          response=$(curl -s -X POST "https://accounts.spotify.com/api/token" \
            -H "Authorization: Basic $auth" \
            -d grant_type=refresh_token \
            -d refresh_token="${{ steps.parse_creds.outputs.refresh_token }}")
          access_token=$(echo "$response" | jq -r '.access_token')
          echo "access_token=$access_token" >> $GITHUB_OUTPUT

      # Check for recent Spotify activity (only run metrics if a track was played)
      - name: Check for Spotify changes
        id: check_spotify
        shell: bash
        run: |
          access_token="${{ steps.get_token.outputs.access_token }}"
          response=$(curl -s -X GET "https://api.spotify.com/v1/me/player/recently-played?limit=1" -H "Authorization: Bearer $access_token")
          track_id=$(echo "$response" | jq -r '.items[0].track.id // empty')
          if [ -z "$track_id" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # Generate 'Recently listened' metrics if recent activity is detected
      - name: Spotify - Recently listened
        if: steps.check_spotify.outputs.changed == 'true'
        uses: lowlighter/metrics@master
        with:
          filename: metrics.plugin.music.recent.svg
          token: ${{ secrets.METRICS_TOKEN }}
          base: ""
          plugin_music: yes
          plugin_music_provider: spotify
          plugin_music_mode: recent
          plugin_music_token: ${{ secrets.SPOTIFY_TOKENS }}
          plugin_music_limit: 10
          plugin_music_time_range: short
          output_action: gist
          committer_gist: ${{ secrets.GIST }}

      # Generate 'Top artists' metrics if recent activity is detected
      - name: Spotify - Top artists
        if: steps.check_spotify.outputs.changed == 'true'
        uses: lowlighter/metrics@master
        with:
          filename: metrics.plugin.music.top.artists.svg
          token: ${{ secrets.METRICS_TOKEN }}
          base: ""
          plugin_music: yes
          plugin_music_mode: top
          plugin_music_provider: spotify
          plugin_music_token: ${{ secrets.SPOTIFY_TOKENS }}
          plugin_music_limit: 10
          plugin_music_time_range: short
          plugin_music_top_type: artists
          output_action: gist
          committer_gist: ${{ secrets.GIST }}
